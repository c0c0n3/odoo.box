Vaultgen
--------
> Nix package docs.

This package Nixifies the [script][script] to populate the `odbox`
vault. That is, the files (secrets) the [odbox.vault][module] lists.
This package ties the script to the `vaultgen` command.


### vaultgen command

Generate [odbox.vault][module] secrets.
This script typically creates a `vault` directory with the files
listed below.

```
 vault
 ├── .gitignore                # make git track only encrypted or pub files
 ├── age.key                   # generated Age identity
 ├── certs
 │  ├── localhost-cert.pem     # generated localhost pub cert signed w/ vault-ca
 │  ├── localhost-cert.pem.age # Age-encrypted localhost pub cert
 │  ├── localhost-key.pem      # generated localhost cert key
 │  ├── localhost-key.pem.age  # Age-encrypted localhost cert key
 │  ├── prod-cert.pem          # imported prod pub cert
 │  ├── prod-cert.pem.age      # Age-encrypted prod pub cert
 │  ├── prod-key.pem           # imported prod cert key
 │  ├── prod-key.pem.age       # Age-encrypted prod cert key
 │  ├── vault-ca-cert.pem      # self-signed CA pub cert
 │  ├── vault-ca-cert.pem.age  # Age-encrypted CA pub cert
 │  ├── vault-ca-key.pem       # generated CA cert key
 │  └── vault-ca-key.pem.age   # Age-encrypted CA cert key
 ├── passwords
 │  ├── admin                  # clear-text admin pwd (generated or entered)
 │  ├── admin.age              #   Age-encrypted clear-text pwd
 │  ├── admin.sha512           #   SHA512-hashed pwd `chpasswd` can handle
 │  ├── admin.sha512.age       #   corresponding Age-encrypted hashed pwd
 │  ├── admin.yesc             #   Yescrypt-hashed pwd `chpasswd` can handle
 │  ├── admin.yesc.age         #   corresponding Age-encrypted hashed pwd
 │  ├── odoo-admin             # clear-text Odoo admin pwd (generated or entered)
 │  ├── odoo-admin.age         #   Age-encrypted clear-text pwd
 │  ├── odoo-admin.sha512      #   SHA512-hashed pwd `chpasswd` can handle
 │  ├── odoo-admin.sha512.age  #   corresponding Age-encrypted hashed pwd
 │  ├── odoo-admin.yesc        #   Yescrypt-hashed pwd `chpasswd` can handle
 │  ├── odoo-admin.yesc.age    #   corresponding Age-encrypted hashed pwd
 │  ├── pgadmin-admin          # clear-text PgAdmin UI admin pwd (generated or entered)
 │  ├── pgadmin-admin.age      #   Age-encrypted clear-text pwd
 │  ├── pgadmin-admin.sha512   #   SHA512-hashed pwd `chpasswd` can handle
 │  ├── pgadmin-admin.sha512.age #   corresponding Age-encrypted hashed pwd
 │  ├── pgadmin-admin.yesc     #   Yescrypt-hashed pwd `chpasswd` can handle
 │  ├── pgadmin-admin.yesc.age #   corresponding Age-encrypted hashed pwd
 │  ├── root                   # clear-text root pwd (generated or entered)
 │  ├── root.age               #   Age-encrypted clear-text pwd
 │  ├── root.sha512            #   hashed pwd that `chpasswd` can handle
 │  ├── root.sha512.age        #   Age-encrypted hashed pwd
 │  ├── root.yesc              #   Yescrypt-hashed pwd `chpasswd` can handle
 │  └── root.yesc.age          #   corresponding Age-encrypted hashed pwd
 └── ssh
    ├── id_ed25519             # generated ED25519 identity
    └── id_ed25519.pub         # corresponding public key
```

Notice `vault/age.key` contains the pub/private key pair (identity)
to encrypt and decrypt all the Age files. If the file already exist,
this script will use it to encrypt. This way you can easily encrypt
different passwords and certs with a previously generated Age identity.
Similarly, if the SSH identity file already exists, this script won't
override it with a newly generated one.

There's a set of four password files for each built-in user: NixOS
root user, NixOS admin user, Odoo Web UI admin, and PgAdmin Web UI
admin. Each set incudes the following files:
- Clear text. A file containing the password in clear text. This is
  either the password you specified or the (strong, memorable) one
  the script automatically generated if you didn't specify one.
- Age. A file containing the password encrypted using `age` and the
  `age` key automatically generated by this script.
- SHA512. A file containing a SHA512 hash of the password `chpasswd`
  can handle.
- SHA512 Age. A file containing the SHA512 hash encrypted using `age`
  and the `age` key automatically generated by this script.
- Yescrypt. A file containing a Yescrypt hash of the password
  `chpasswd` can handle.
- Yescrypt Age. A file containing the Yescrypt hash encrypted
  using `age` and the `age` key automatically generated by
  this script.

As for certificates, there's a set of four files for each kind of
certificate we need:
- Pub cert file. Contains the public certificate.
- Age pub cert file. Contains the Age-encrypted public certificate.
  (Technically this one doesn't need to be encrypted, but we do it
  anyway so you can easily use this file too with Agenix.)
- Cert key file. Contains the certificate's private key.
- Age key file. Contains the Age-encrypted certificate's private key.

This script automatically generates a basic self-signed, 100-year
valid, RSA TLS certificate in PEM format for a CA and then uses it
to sign all the other certs. There's only one other certificate for
the localhost CN by default, but you can change the CN to something
else—see below. This script can also import the prod pub cert and
private key into the `vault/certs` directory. On importing, it
encrypts the private key and writes it to a corresponding `.age`
file.
If the CA files are there already the script won't generate them
again. Ditto for certificates. This way you can easily add new certs
to your vault and sign them with the existing CA. But keep in mind
if you remove the CA files, then you should zap all the certs that
were signed with that CA too as we don't check that. For example, if
you delete the CA files but keep a certificate for `my.dom`, the CA
files get generated again, but the `my.dom` files will still be the
ones signed with the old CA. Read the articles below for a quick
intro to CAs, certs and how to add a CA to your browser to make it
validate the certificates we generate:
- https://gist.github.com/soarez/9688998
- https://hackernoon.com/how-to-get-sslhttps-for-localhost-i11s3342

Finally notice this script also generates a safety-net `.gitignore`
file. The file tells git to ignore any file this script may output
except for Age-encrypted and public key files.

You can run this script in either interactive or batch mode. In
interactive mode, the script asks you to enter passwords for the
root, admin and Odoo admin users. If you don't enter a password
for one of them, a strong one gets automatically generated for
you. The script then asks you to enter a CN for the self-signed
cert. If you don't enter one, it defaults to localhost. Finally,
the script asks you to import the prod pub cert and private key.
If you don't have them, just skip this step.

In batch mode, this script won't prompt you for the above params.
Instead, you use env vars to specify those values:
- `ROOT_PASSWORD`. Clear-text password for the root user. Don't
  set this var to have the script generate one for you.
- `ADMIN_PASSWORD`. Clear-text password for the admin user. Don't
  set this var to have the script generate one for you.
- `ODOO_ADMIN_PASSWORD`. Clear-text password for the Odoo admin
  user. Don't set this var to have the script generate one for you.
- `PGADMIN_ADMIN_PASSWORD`. Clear-text password for the PgAdmin Web
  UI admin user. Don't set this var to have the script generate one
  for you.
- `DOMAIN`. List of space-separated CN names, one for each domain
  certificate to generate. Defaults to localhost if not set.
- `PROD_CERT`. Path to a prod public certificate file to copy over
  to `vault/certs`. Don't set, if you don't have a cert.
- `PROD_CERT_KEY`. Path to the corresponding key file to copy over
  to `vault/certs`. Don't set, if you don't have a cert.

Notice the script will start in interactive mode unless you set
the `BATCH_MODE` env var to `1`. Here's an example batch mode
invocation with all the parameters set

```bash
$ BATCH_MODE=1 \
  ROOT_PASSWORD=abc123 ADMIN_PASSWORD=xy \
  ODOO_ADMIN_PASSWORD=123 PGADMIN_ADMIN_PASSWORD=foo \
  DOMAIN='localhost test.com' \
  PROD_CERT=c.pem PROD_CERT_KEY=k.pem \
  vaultgen
```




[module]: ../../modules/vault/docs.md
[script]: ./gen.sh
